<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Document</title>
</head>
<body>
<script>
const set = [
  [ [ 30, 31, 32, 33 ], [ 01, 11, 21, 31 ], [ 02, 12, 22, 32 ], [ 10, 11, 12, 13 ] ],
  [ [ 21, 22, 31, 32 ], [ 21, 22, 31, 32 ], [ 21, 22, 31, 32 ], [ 21, 22, 31, 32 ] ],
  [ [ 21, 31, 32, 33 ], [ 12, 22, 31, 32 ], [ 10, 11, 12, 22 ], [ 20, 21, 22, 32 ] ]
]
class Te{
  constructor(){
    this.buffer = new Uint8ClampedArray(1<<8)
    this.block = Array(4).fill(-1)
    this.blockType = 0
  }
  b(){
    const _b = set[1 * Math.random() | 0][0]
    for(let i = 0; i < this.block.length; i ++){
      this.block[i] = _b[i] + 8
    }
    this.__ = 0x0f
    // this.b0 = 47
    // this.b1 = 48
    // this.b2 = 49
    // this.b3 = 50
  }
  c(){
    const { buffer } = this
    
    let offset = 0xff
    while(offset > 54){
      let ding = 0x1
      for(let i = 0; i < 10; i ++){
        ding &= buffer[offset - 1 - i]
      }
      if(ding){
        let cur = offset
        while(cur > 64){
          buffer[cur] = buffer[cur - 10]
          cur --
        }
        while(cur > 54){
          buffer[cur] = 0x0
          cur --
        }
      }
      else{
        offset -= 10
      }
    }
  }
  d(){
    const { buffer } = this
    if(this.block.some(b => b < 0x00) || this.block.some(b => b > 0xff)){
      this.b()
    }
    for(let i = 0; i < this.block.length; i ++){
      buffer[this.block[i] + 10] = this.__
      buffer[this.block[i]] = 0
      this.block[i] += 10
    }
    this.c()
  }
  l(){ }
  r(){ }
}

const canvas = document.createElement('canvas'),
  ctx = canvas.getContext('2d')

canvas.style.border = '1px solid red'
canvas.width = 100
canvas.height = 240
document.body.appendChild(canvas)

const colors = ['red', 'blue', 'green', '#398', 'red', 'blue', 'green', '#398', 'red', 'blue', 'green', '#398']

const t = new Te

const render = () => {
  const { buffer } = t
  ctx.clearRect(0, 0, 100, 240)

  let offset = 0
  while(offset < 240){
    const b = buffer[offset + 15]
    if(b & 1){
      ctx.fillStyle = colors[b & 15 >> 1]
      // console.log(offset + 55)
      ctx.fillRect((offset % 10) * 10, (offset / 10 | 0) * 10, 9, 9)
    }
    offset ++
  }
  document.title = t.b0
  requestAnimationFrame(render)
}
setInterval(() => t.d(), 1000)

render()
</script>
</body>
</html>
