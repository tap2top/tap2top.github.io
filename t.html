<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Document</title>
</head>
<body tabindex="1">
<canvas></canvas>
<script>
const set = [
  [ 0, 0, 0, 0, 0b11, 0b11, 0, 0, 0, 0 ],
  [ 0, 0, 0, 0, 0b1111, 0, 0, 0, 0, 0 ],
  [ 0, 0, 0, 0, 0b111, 0b100, 0, 0, 0, 0 ],
  [ 0, 0, 0, 0, 0b100, 0b111, 0, 0, 0, 0 ],
  [ 0, 0, 0, 0, 0b110, 0b11, 0, 0, 0, 0 ],
  [ 0, 0, 0, 0, 0b11, 0b110, 0, 0, 0, 0 ],
  [ 0, 0, 0, 0, 0b111, 0b10, 0, 0, 0, 0 ]
]
class B{
  constructor(){
    const data = set[Math.random() * set.length ^ 0]
    let rotate = 0, x = 0, y = 20
    const check0 = (v, a) => {
      if(v[0]){
        if(a){
          v[0] = 0
        }
        else{
          v[1] = v[1] + 1
        }
      }
      return v
    }
    Object.defineProperties(this, {
      rotate: {
        get: () => rotate,
        set: v => {
          switch(v){
            case 0: case 1: case 2: case 3: rotate = v
          }
        }
      },
      x: {
        get: () => x,
        set: v => {
          const left = data.reduce(check0, [1, 0])[1]
          const right = data.reduceRight(check0, [1, 0])[1]
          if(!isNaN(v) && isFinite(v) && v <= right && v >= -left){
            x = v ^ 0
          }
        }
      },
      y: {
        get: () => y,
        set: v => {
          if(!isNaN(v) && isFinite(v) && v <= 20){
            y = v ^ 0
          }
        }
      },
      data: {
        get: () => {
          let d
          if(this.x > 0){
            d = Array(this.x).concat(data.slice(0, -this.x))
          }
          else if(this.x < 0){
            d = data.slice(- this.x).concat(Array(- this.x).fill(0))
          }
          else{
            d = data.slice()
          }
          d.forEach((c, i) => {
            d[i] = c << this.y
          })
          return d
        }
      }
    })
  }
}
function T(){
  var data = Array(10).fill(0)
  this.block = new B
  Object.defineProperties(this, {
    data: { get: () => data.slice() }
  })
  const check = () => data.some((d, i) => (d | this.block.data[i]) !== (d ^ this.block.data[i]))
  this.rotate = () => {

  }
  this.left = () => {
    this.block.x -= 1
    if(check()){ this.block.x += 1 }
  }
  this.right = () => {
    this.block.x += 1
    if(check()){ this.block.x -= 1 }
  }
  this.down = () => {
    let { block } = this
    block.y -= 1
    if(check()){
      if(block.y >= 19){
        return console.log(data)
      }
      block.y += 1
      data.forEach((d, i) => {
        data[i] = d | block.data[i]
      })
      this.block = new B
    }
    else if(block.y === -1){
      block.y = 0
      data.forEach((d, i) => {
        data[i] = d | block.data[i]
      })
      this.block = new B
    }
    for(var i = 0; i < 24;){
      const done = data.reduce((v, d) => v &= (d >> i & 1), 1)
      if(done){
        data.forEach((d, x) => {
          data[x] = (2 ** i - 1) & data[x] | (data[x] >> (i + 1) << i)
        })
      }
      else{
        i ++
      }
    }
  }
}
var t = new T
var canvas = document.querySelector('canvas')
canvas.width = 100
canvas.height = 240
canvas.style.border = '1px solid red'
const ctx = canvas.getContext('2d')

function render(){
  ctx.clearRect(0, 0, canvas.width, canvas.height)
  var data = t.data
  var block = t.block
  // var mdata = data.map((d, i) => d | block.data[i])
  ctx.beginPath()
  ctx.fillStyle = '#333'
  data.forEach((d, i) => {
    for(var n = 0; n < 24; n ++){
      if(d >> (23 - n) & 1){
        ctx.fillRect(10 * i + 1, n * 10 + 1, 9, 9)
      }
    }
  })
  ctx.closePath()

  ctx.beginPath()
  ctx.fillStyle = '#39c'
  block.data.forEach((d, i) => {
    for(var n = 0; n < 24; n ++){
      if(d >> (23 - n) & 1){
        ctx.fillRect(10 * i + 1, n * 10 + 1, 9, 9)
      }
    }
  })
  ctx.closePath()

  requestAnimationFrame(render)
}
window.addEventListener('keypress', e => {
  switch(e.keyCode){
    case 97: return t.left()
    case 100: return t.right()
    case 115: return t.down()
    case 119: return t.rotate()
  }
})
render()
</script>
</body>
</html>
